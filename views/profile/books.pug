extends ../layout

block content
    .container.mt-5.mb-5
        h2.mb-4 My Listed Books
        if books.length === 0
            .alert.alert-info You have not listed any books yet.
            a.btn.btn-primary(href='/books/sell') List a Book
        else
            .row.g-4
                each book in books
                    .col-md-4.col-lg-3
                        .card.h-100.shadow-sm
                            if book.coverImage
                                img.card-img-top(src=book.coverImage alt=book.title style='height: 220px; object-fit: cover;')
                            else
                                img.card-img-top(src='https://source.unsplash.com/400x600/?book,' + encodeURIComponent(book.title) alt=book.title style='height: 220px; object-fit: cover;' onerror="this.onerror=null;this.src='/images/default-book.png';")
                            .card-body.d-flex.flex-column
                                h5.card-title.mb-2 #{book.title}
                                p.card-text.text-muted.mb-1 Author: #{book.author}
                                p.card-text.text-muted.mb-1 Price: Â£#{Number(book.price).toFixed(2)}
                                p.card-text.text-muted.mb-1 Condition: #{book.condition || 'New'}
                                p.card-text.text-muted.mb-1 Status: #{book.status || 'Available'}
                                if book.description
                                    p.card-text.mt-2 #{book.description.substring(0, 60)}...
                                else
                                    p.card-text.mt-2.text-muted No description available
                                
                                // Literary Escape Room Lock Controls
                                .lock-controls.mt-3.p-2.bg-light.rounded
                                    if book.hasChallenge
                                        // Book is locked
                                        .d-flex.align-items-center.justify-content-between.mb-2
                                            div
                                                i.fas.fa-lock.me-2.text-warning
                                                small.fw-bold Book is locked ðŸ”’
                                            div
                                                .form-check.form-switch
                                                    input.form-check-input.lock-toggle(type='checkbox' checked data-book-id=book.id id='lockToggle-' + book.id)
                                                    label.form-check-label(for='lockToggle-' + book.id) Locked
                                        small.text-muted Buyers must solve your challenge to purchase
                                        // Remove Lock button
                                        form(method='POST', action='/challenges/remove/' + book.id, style='display:inline', onsubmit='return confirm("Are you sure you want to remove the lock from this book?");')
                                            button.btn.btn-outline-danger.btn-sm.mt-2(type='submit') Remove Lock
                                        // Success message area
                                        if book.justLocked
                                            .alert.alert-success.mt-2
                                                i.fas.fa-check-circle.me-2
                                                | Challenge created and book locked!
                                    else
                                        // Book is unlocked
                                        .d-flex.align-items-center.justify-content-between.mb-2
                                            div
                                                i.fas.fa-unlock.me-2.text-success
                                                small.fw-bold Available for direct purchase
                                            div
                                                .form-check.form-switch
                                                    input.form-check-input.lock-toggle(type='checkbox' data-book-id=book.id id='lockToggle-' + book.id)
                                                    label.form-check-label(for='lockToggle-' + book.id) Lock Book
                                        small.text-muted Buyers can purchase immediately
                                // Lock-question form (hidden by default)
                                form.lock-question-form.mt-3.p-3.bg-white.rounded.shadow-sm(style='display:none;' id='lockQuestionForm-' + book.id method='POST' action='/challenges/create')
                                    input(type='hidden' name='bookId' value=book.id)
                                    .mb-3.text-center
                                        label.form-label(for='question-' + book.id) Enter a question buyers must answer to unlock this book:
                                        input.form-control(type='text' name='question' id='question-' + book.id required placeholder='e.g. What is the main theme of this book?')
                                    .mb-3.text-center
                                        label.form-label(for='answer-' + book.id) Enter the answer (required to unlock):
                                        input.form-control(type='text' name='answer' id='answer-' + book.id required placeholder='e.g. Courage')
                                    .d-flex.justify-content-center
                                        button.btn.btn-success(type='submit') Save & Lock
                                
                                .mt-auto.d-flex.justify-content-between.align-items-center
                                    a.btn.btn-outline-primary.btn-sm(href='/books/' + book.id + '/edit') Edit
                                    button.btn.btn-outline-danger.btn-sm(type='button', data-bs-toggle='modal', data-bs-target='#deleteModal-' + book.id) Delete
            // Move all modals to the bottom for stability
            each book in books
                .modal.fade(id='deleteModal-' + book.id, tabindex='-1', aria-labelledby='deleteModalLabel-' + book.id, aria-hidden='true', data-bs-backdrop='static', data-bs-keyboard='false')
                    .modal-dialog.modal-dialog-centered
                        .modal-content
                            .modal-header.bg-danger.text-white
                                h5.modal-title(id='deleteModalLabel-' + book.id) Confirm Delete
                                button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
                            .modal-body
                                p Are you sure you want to delete this book?
                                p.text-danger This action cannot be undone.
                            .modal-footer
                                button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
                                form(method='POST', action='/books/' + book.id + '/delete', style='display:inline')
                                    button.btn.btn-danger(type='submit') Yes, Delete
